{% if pagination and pagination.total_pages > 1 %}
<div class="d-sm-flex justify-content-between align-items-center mt-4">

    <!-- Thông tin trang hiện tại -->
    <div class="text-muted mb-2 mb-sm-0 text-center text-sm-start">
        Hiển thị trang <strong>{{ pagination.page }}</strong> trên tổng số <strong>{{ pagination.total_pages }}</strong> trang
    </div>

    <!-- Các nút phân trang -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center justify-content-sm-end mb-0">

            <!-- Nút Trang trước -->
            <li class="page-item {% if pagination.page == 1 %}disabled{% endif %}">
                <!-- THAY ĐỔI: Thêm &{{ current_query_string }} -->
                <a class="page-link" 
                   href="{{ url_for(request.endpoint, page=pagination.page - 1) }}&{{ current_query_string }}" 
                   aria-label="Trang trước">
                    <span>&laquo;</span>
                </a>
            </li>

            {# Logic hiển thị thông minh #}
            {% set start_page = [1, pagination.page - 2] | max %}
            {% set end_page = [pagination.total_pages, pagination.page + 2] | min %}
            
            {% if start_page > 1 %}
                <li class="page-item">
                    <!-- THAY ĐỔI: Thêm &{{ current_query_string }} -->
                    <a class="page-link" href="{{ url_for(request.endpoint, page=1) }}&{{ current_query_string }}">1</a>
                </li>
                {% if start_page > 2 %}
                    <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
                {% endif %}
            {% endif %}

            {% for p in range(start_page, end_page + 1) %}
                <li class="page-item {% if p == pagination.page %}active{% endif %}">
                    <!-- THAY ĐỔI: Thêm &{{ current_query_string }} -->
                    <a class="page-link" 
                       href="{{ url_for(request.endpoint, page=p) }}&{{ current_query_string }}">
                       {{ p }}
                    </a>
                </li>
            {% endfor %}

            {% if end_page < pagination.total_pages %}
                {% if end_page < pagination.total_pages - 1 %}
                    <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
                {% endif %}
                <li class="page-item">
                    <!-- THAY ĐỔI: Thêm &{{ current_query_string }} -->
                    <a class="page-link" href="{{ url_for(request.endpoint, page=pagination.total_pages) }}&{{ current_query_string }}">
                        {{ pagination.total_pages }}
                    </a>
                </li>
            {% endif %}

            <!-- Nút Trang sau -->
            <li class="page-item {% if pagination.page == pagination.total_pages %}disabled{% endif %}">
                <!-- THAY ĐỔI: Thêm &{{ current_query_string }} -->
                <a class="page-link" 
                   href="{{ url_for(request.endpoint, page=pagination.page + 1) }}&{{ current_query_string }}" 
                   aria-label="Trang sau">
                    <span>&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
</div>
{% endif %}